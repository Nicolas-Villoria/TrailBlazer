<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrailBlazer - Route Explorer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .form-select, .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
        }
        
        .monument-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .monument-card:hover {
            transform: translateY(-5px);
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .status-pending { background-color: #ffeaa7; color: #2d3436; }
        .status-processing { background-color: #74b9ff; color: white; }
        .status-completed { background-color: #00b894; color: white; }
        .status-failed { background-color: #e17055; color: white; }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1>üó∫Ô∏è TrailBlazer</h1>
                <p>Discover the shortest routes to historical treasures</p>
            </div>
            
            <!-- Map -->
            <div id="map"></div>
            
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="monumentType" class="form-label fw-bold">Monument Type</label>
                        <select class="form-select" id="monumentType">
                            <option value="">Select monument type...</option>
                            <option value="militars">üè∞ Military Buildings</option>
                            <option value="religiosos">‚õ™ Religious Buildings</option>
                            <option value="civils">üèõÔ∏è Civil Buildings</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="startLat" class="form-label fw-bold">Start Latitude</label>
                        <input type="number" class="form-control" id="startLat" step="0.000001" 
                               placeholder="e.g., 41.3851" value="41.3851">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="startLon" class="form-label fw-bold">Start Longitude</label>
                        <input type="number" class="form-control" id="startLon" step="0.000001" 
                               placeholder="e.g., 2.1734" value="2.1734">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-success me-2" onclick="loadMonuments()">
                            üîç Preview Monuments
                        </button>
                        <button class="btn btn-primary" onclick="calculateRoutes()">
                            üß≠ Calculate Routes
                        </button>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-secondary" onclick="setCurrentLocation()">
                            üìç Use My Location
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="progressSection" class="mb-4" style="display: none;">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üîÑ Route Calculation Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%">
                                <span id="progressText" style="font-weight: bold; font-size: 14px;">0%</span>
                            </div>
                        </div>
                        <p class="mb-0" id="progressStatus" style="font-size: 16px;">üöÄ Initializing...</p>
                        <small class="text-muted">üí° Tip: Check the browser console (F12) for detailed progress logs</small>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <h4>üìç Found Monuments</h4>
                <div id="monumentsList"></div>
                
                <div id="routeResults" style="display: none;">
                    <h4>üõ§Ô∏è Route Results</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <a id="downloadPNG" class="btn btn-outline-primary" href="#" target="_blank">
                                üì∏ Download Route Map (PNG)
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a id="downloadKML" class="btn btn-outline-success" href="#" target="_blank">
                                üó∫Ô∏è Download KML File
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let map;
        let startMarker;
        let monumentMarkers = [];
        let currentJobId = null;
        
        // API base URL - change this to your backend URL
        const API_BASE = 'http://localhost:8000';
        
        // Debug function to test API connectivity
        async function testAPIConnection() {
            console.log('üîß Testing API connection...');
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ API connection successful:', data);
                    return true;
                } else {
                    console.error('‚ùå API health check failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå API connection error:', error);
                return false;
            }
        }
        
        // Initialize map
        function initMap() {
            // Center on Catalunya
            map = L.map('map').setView([41.5, 2.0], 8);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add click handler for setting start point
            map.on('click', function(e) {
                setStartPoint(e.latlng.lat, e.latlng.lng);
            });
            
            // Set initial start point (Barcelona)
            setStartPoint(41.3851, 2.1734);
        }
        
        function setStartPoint(lat, lng) {
            // Remove existing start marker
            if (startMarker) {
                map.removeLayer(startMarker);
            }
            
            // Add new start marker
            startMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            startMarker.bindPopup('üöÄ Start Point').openPopup();
            
            // Update form fields
            document.getElementById('startLat').value = lat.toFixed(6);
            document.getElementById('startLon').value = lng.toFixed(6);
        }
        
        function setCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setStartPoint(lat, lng);
                    map.setView([lat, lng], 12);
                }, function(error) {
                    alert('Error getting location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
        
        async function loadMonuments() {
            const monumentType = document.getElementById('monumentType').value;
            console.log('üè∞ Loading monuments of type:', monumentType);
            
            if (!monumentType) {
                alert('Please select a monument type first.');
                return;
            }
            
            try {
                // Clear existing monument markers
                monumentMarkers.forEach(marker => map.removeLayer(marker));
                monumentMarkers = [];
                
                // Get map bounds for search area
                const bounds = map.getBounds();
                console.log('üìç Map bounds:', bounds);
                const box = {
                    bottom_left: {
                        lat: bounds.getSouth(),
                        lon: bounds.getWest()
                    },
                    top_right: {
                        lat: bounds.getNorth(),
                        lon: bounds.getEast()
                    }
                };
                
                console.log('üì° Making API request to:', `${API_BASE}/monuments/${monumentType}`);
                console.log('üì¶ Request body:', box);
                
                const response = await fetch(`${API_BASE}/monuments/${monumentType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(box)
                });
                
                console.log('üì• API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üéâ API response data:', data);
                console.log(`üìä Found ${data.monuments?.length || 0} monuments`);
                displayMonuments(data.monuments);
                
            } catch (error) {
                console.error('üö® Error loading monuments:', error);
                console.error('üìç Request details:', {
                    url: `${API_BASE}/monuments/${monumentType}`,
                    body: box,
                    monumentType: monumentType
                });
                
                let errorMessage = 'Unknown error';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to backend server. Make sure it\'s running on port 8000.';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `Server error: ${error.message}`;
                } else {
                    errorMessage = error.message;
                }
                
                alert('Error loading monuments: ' + errorMessage);
                console.log('üí° Tip: Check browser console for more details');
            }
        }
        
        function displayMonuments(monuments) {
            const monumentsList = document.getElementById('monumentsList');
            monumentsList.innerHTML = '';
            
            if (monuments.length === 0) {
                monumentsList.innerHTML = '<p class="text-muted">No monuments found in the current view. Try zooming out or changing the monument type.</p>';
                document.getElementById('resultsSection').style.display = 'block';
                return;
            }
            
            monuments.forEach((monument, index) => {
                // Add marker to map
                const marker = L.marker([monument.location.lat, monument.location.lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                marker.bindPopup(`<strong>${monument.name}</strong><br>
                                 Lat: ${monument.location.lat.toFixed(6)}<br>
                                 Lon: ${monument.location.lon.toFixed(6)}`);
                
                monumentMarkers.push(marker);
                
                // Add to list
                const monumentCard = document.createElement('div');
                monumentCard.className = 'monument-card';
                monumentCard.innerHTML = `
                    <h6>${monument.name}</h6>
                    <small class="text-muted">
                        üìç ${monument.location.lat.toFixed(4)}, ${monument.location.lon.toFixed(4)}
                    </small>
                `;
                
                monumentCard.addEventListener('click', () => {
                    map.setView([monument.location.lat, monument.location.lon], 15);
                    marker.openPopup();
                });
                
                monumentsList.appendChild(monumentCard);
            });
            
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        async function calculateRoutes() {
            const monumentType = document.getElementById('monumentType').value;
            const startLat = parseFloat(document.getElementById('startLat').value);
            const startLon = parseFloat(document.getElementById('startLon').value);
            
            if (!monumentType || isNaN(startLat) || isNaN(startLon)) {
                alert('Please fill in all required fields and select a monument type.');
                return;
            }
            
            try {
                // Get map bounds for search area
                const bounds = map.getBounds();
                
                const routeRequest = {
                    start_point: {
                        lat: startLat,
                        lon: startLon
                    },
                    monument_type: monumentType,
                    search_box: {
                        bottom_left: {
                            lat: bounds.getSouth(),
                            lon: bounds.getWest()
                        },
                        top_right: {
                            lat: bounds.getNorth(),
                            lon: bounds.getEast()
                        }
                    }
                };
                
                const response = await fetch(`${API_BASE}/routes/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(routeRequest)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentJobId = data.job_id;
                
                console.log(`üöÄ Route calculation started! Job ID: ${currentJobId}`);
                console.log('üìù Route request:', routeRequest);
                
                // Show progress section with initial status
                document.getElementById('progressSection').style.display = 'block';
                updateProgress({
                    status: 'processing',
                    progress: 5.0
                });
                
                // Start polling for status
                pollJobStatus();
                
            } catch (error) {
                console.error('Error calculating routes:', error);
                alert('Error calculating routes: ' + error.message);
            }
        }
        
        async function pollJobStatus() {
            if (!currentJobId) return;
            
            try {
                console.log(`üîÑ Polling status for job: ${currentJobId}`);
                const response = await fetch(`${API_BASE}/routes/status/${currentJobId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const status = await response.json();
                console.log(`üìä Job status update:`, status);
                updateProgress(status);
                
                if (status.status === 'completed') {
                    console.log('üéâ Route calculation completed!');
                    displayRouteResults(status.result);
                } else if (status.status === 'failed') {
                    console.error('‚ùå Route calculation failed:', status.error);
                    alert('Route calculation failed: ' + status.error);
                    document.getElementById('progressSection').style.display = 'none';
                } else {
                    // Continue polling every 2 seconds
                    console.log(`‚è≥ Continuing to poll... Status: ${status.status}, Progress: ${status.progress}%`);
                    setTimeout(pollJobStatus, 2000);
                }
                
            } catch (error) {
                console.error('üö® Error polling job status:', error);
                // Retry after 5 seconds if there's a network error
                setTimeout(pollJobStatus, 5000);
            }
        }
        
        function updateProgress(status) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');
            
            // Update progress bar
            progressBar.style.width = status.progress + '%';
            progressText.textContent = Math.round(status.progress) + '%';
            
            // Detailed status messages based on progress
            let statusMessage = '';
            let progressClass = 'mt-2 text-muted';
            
            if (status.status === 'failed') {
                statusMessage = `‚ùå Calculation failed: ${status.error || 'Unknown error'}`;
                progressClass = 'mt-2 text-danger';
                progressBar.className = 'progress-bar bg-danger';
            } else if (status.status === 'completed') {
                statusMessage = '‚úÖ Route calculation completed successfully!';
                progressClass = 'mt-2 text-success';
                progressBar.className = 'progress-bar bg-success';
            } else {
                // Processing status with detailed steps
                if (status.progress < 10) {
                    statusMessage = 'üöÄ Initializing route calculation...';
                } else if (status.progress < 30) {
                    statusMessage = 'üì° Connecting to backend server...';
                } else if (status.progress < 50) {
                    statusMessage = 'üó∫Ô∏è Loading trail segments from OpenStreetMap...';
                } else if (status.progress < 70) {
                    statusMessage = 'üîó Building navigation graph...';
                } else if (status.progress < 90) {
                    statusMessage = 'üè∞ Loading monuments data...';
                } else {
                    statusMessage = 'üßÆ Calculating optimal routes...';
                }
                
                progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
            }
            
            progressStatus.textContent = statusMessage;
            progressStatus.className = progressClass;
            
            // Add timestamp for debugging
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] Progress: ${Math.round(status.progress)}% - ${statusMessage}`);
        }
        
        function displayRouteResults(result) {
            document.getElementById('progressSection').style.display = 'none';
            
            // Update download links
            document.getElementById('downloadPNG').href = API_BASE + result.png_url;
            document.getElementById('downloadKML').href = API_BASE + result.kml_url;
            
            // Show route results section
            document.getElementById('routeResults').style.display = 'block';
            
            // Update monuments list with distances
            const monumentsList = document.getElementById('monumentsList');
            monumentsList.innerHTML = '';
            
            result.monuments.forEach(monument => {
                const monumentCard = document.createElement('div');
                monumentCard.className = 'monument-card';
                monumentCard.innerHTML = `
                    <h6>${monument.name}</h6>
                    <small class="text-muted">
                        üìç ${monument.location.lat.toFixed(4)}, ${monument.location.lon.toFixed(4)}
                        ${monument.distance ? `<br>üö∂ Distance: ${monument.distance.toFixed(2)} km` : ''}
                    </small>
                `;
                monumentsList.appendChild(monumentCard);
            });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ TrailBlazer application starting...');
            initMap();
            
            // Test API connection on startup
            testAPIConnection().then(isConnected => {
                if (!isConnected) {
                    console.error('‚ö†Ô∏è Backend connection failed. Make sure backend is running on port 8000');
                    alert('Warning: Cannot connect to backend server. Make sure it\'s running on http://localhost:8000');
                }
            });
        });
    </script>
</body>
</html>